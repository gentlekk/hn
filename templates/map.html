<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>ç»¼åˆå¯¼èˆªï¼ˆåœ°å+åæ ‡æ··è¾“ï¼‰</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: "å¾®è½¯é›…é»‘";
    background: #f0f0f0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
#container {
    display: flex;
    width: 90vw;
    height: 80vh;
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}
#panel {
    width: 320px;
    padding: 20px;
    box-sizing: border-box;
    background: #fff;
    overflow-y: auto;
    box-shadow: 2px 0 6px rgba(0,0,0,0.1);
}
input, select, button {
    width: 100%;
    margin: 5px 0;
    padding: 8px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ddd;
}
#result {
    margin-top: 10px;
    font-size: 14px;
    max-height: 80px;
    overflow-y: auto;
}
#routePanel {
    margin-top: 10px;
    font-size: 14px;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 5px;
    background: #fafafa;
    border-radius: 4px;
}
#map {
    flex-grow: 1;
    height: 100%;
}
</style>
<script src="//api.map.baidu.com/api?type=webgl&v=1.0&ak=7r6ZcsSPnohgHTpn20LsUEfunC6S5vW8"></script>
</head>
<body>

<div id="container">
  <div id="panel">
      <b>ğŸ—ºï¸ ç»¼åˆå¯¼èˆª</b><br><br>
      èµ·ç‚¹ï¼š
      <input type="text" id="start" value="ç™¾åº¦å¤§å¦" />
      ç»ˆç‚¹ï¼š
      <input type="text" id="end" value="å¤©å®‰é—¨" />
      å‡ºè¡Œæ–¹å¼ï¼š
      <select id="mode">
          <option value="driving">ğŸš— é©¾è½¦</option>
          <option value="walking">ğŸš¶ æ­¥è¡Œ</option>
          <option value="riding">ğŸš´ éª‘è¡Œ</option>
          <option value="transit">ğŸšŒ å…¬äº¤</option>
      </select>
      å…¬äº¤ç­–ç•¥ï¼š
      <select id="policy">
          <option value="0">æ¨èæ–¹æ¡ˆ</option>
          <option value="1">æœ€å°‘æ—¶é—´</option>
          <option value="2">æœ€å°‘æ¢ä¹˜</option>
          <option value="3">æœ€å°‘æ­¥è¡Œ</option>
          <option value="4">ä¸ä¹˜åœ°é“</option>
          <option value="5">ä¼˜å…ˆåœ°é“</option>
      </select>
      <button onclick="searchRoute()">æŸ¥è¯¢è·¯çº¿</button>
      <div id="result"></div>
      <div id="routePanel"></div>
      <br />
      å…³é”®å­—æœç´¢ï¼š
      <input type="text" id="keyword" value="æ™¯ç‚¹" />
      <button onclick="searchKeyword()">æœç´¢å…³é”®å­—</button>
  </div>

  <div id="map"></div>
</div>

<script>
var map = new BMapGL.Map("map");
var geolocation = new BMapGL.Geolocation();
geolocation.getCurrentPosition(function(r) {
    if (this.getStatus() == BMAP_STATUS_SUCCESS) {
        var userPoint = r.point;
        map.centerAndZoom(userPoint, 15);
        map.addOverlay(new BMapGL.Marker(userPoint));
    } else {
        alert("å®šä½å¤±è´¥ï¼Œå°†æ˜¾ç¤ºé»˜è®¤ä½ç½®ï¼šåŒ—äº¬");
        map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 13);
    }
});
map.enableScrollWheelZoom(true);

function clearMap() {
    map.clearOverlays();
    document.getElementById("result").innerHTML = "";
    document.getElementById("routePanel").innerHTML = "";
}

// è§£æåœ°åæˆ–åæ ‡å­—ç¬¦ä¸²ä¸ºåæ ‡ç‚¹ï¼Œcallback è¿”å› BMapGL.Point
function parseToPoint(str, callback) {
    if (str.includes(",")) {
        let [lng, lat] = str.split(",").map(Number);
        if (!isNaN(lng) && !isNaN(lat)) {
            callback(new BMapGL.Point(lng, lat));
            return;
        }
    }
    let geocoder = new BMapGL.Geocoder();
    geocoder.getPoint(str, function(point) {
        if (point) callback(point);
        else alert("æ— æ³•è§£æä½ç½®: " + str);
    });
}

function searchRoute() {
    clearMap();
    let mode = document.getElementById("mode").value;
    let policyIndex = parseInt(document.getElementById("policy").value);
    let policies = [
        BMAP_TRANSIT_POLICY_RECOMMEND,
        BMAP_TRANSIT_POLICY_LEAST_TIME,
        BMAP_TRANSIT_POLICY_LEAST_TRANSFER,
        BMAP_TRANSIT_POLICY_LEAST_WALKING,
        BMAP_TRANSIT_POLICY_AVOID_SUBWAYS,
        BMAP_TRANSIT_POLICY_FIRST_SUBWAYS,
    ];

    let startVal = document.getElementById("start").value.trim();
    let endVal = document.getElementById("end").value.trim();

    if (mode === "walking" || mode === "riding") {
        // ç›´æ¥ç”¨å­—ç¬¦ä¸²èµ·ç»ˆç‚¹ï¼Œè°ƒç”¨search(èµ·ç‚¹å­—ç¬¦ä¸², ç»ˆç‚¹å­—ç¬¦ä¸²)
        if (mode === "walking") {
            let walking = new BMapGL.WalkingRoute(map, {
                renderOptions: { map: map, panel: "routePanel", autoViewport: true },
                onSearchComplete: function(results) {
                    if (walking.getStatus() !== BMAP_STATUS_SUCCESS) {
                        alert("æ­¥è¡Œè·¯çº¿æŸ¥è¯¢å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š" + walking.getStatus());
                    }
                },
            });
            walking.search(startVal, endVal);
            document.getElementById("result").innerHTML = "";
        } else if (mode === "riding") {
            let riding = new BMapGL.RidingRoute(map, {
                renderOptions: { map: map, panel: "routePanel", autoViewport: true },
                onSearchComplete: function(results) {
                    if (riding.getStatus() !== BMAP_STATUS_SUCCESS) {
                        alert("éª‘è¡Œè·¯çº¿æŸ¥è¯¢å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š" + riding.getStatus());
                    }
                },
            });
            riding.search(startVal, endVal);
            document.getElementById("result").innerHTML = "";
        }
    } else {
        // é©¾è½¦å’Œå…¬äº¤ï¼Œå…ˆè§£æåæ ‡ç‚¹ï¼Œå†è°ƒç”¨search
        parseToPoint(startVal, function(start) {
            parseToPoint(endVal, function(end) {
                if (mode === "driving") {
                    let driving = new BMapGL.DrivingRoute(map, {
                        renderOptions: { map: map, autoViewport: true },
                        onSearchComplete: function(results) {
                            if (driving.getStatus() === BMAP_STATUS_SUCCESS) {
                                let plan = results.getPlan(0);
                                let time = plan.getDuration(true);
                                let dist = plan.getDistance(true);
                                document.getElementById("result").innerHTML =
                                    `ğŸš— é©¾è½¦<br>æ—¶é—´ï¼š${time}<br>è·ç¦»ï¼š${dist}`;
                                document.getElementById("routePanel").innerHTML = "";
                            } else {
                                document.getElementById("result").innerHTML = "é©¾è½¦è·¯çº¿æŸ¥è¯¢å¤±è´¥";
                            }
                        },
                    });
                    driving.search(start, end);
                } else if (mode === "transit") {
                    let transit = new BMapGL.TransitRoute(map, {
                        renderOptions: { map: map, panel: "routePanel", autoViewport: true },
                        policy: policies[policyIndex],
                    });
                    transit.search(start, end);
                    document.getElementById("result").innerHTML = "";
                }
            });
        });
    }
}

// è¾“å…¥æç¤º
var ac_start = new BMapGL.Autocomplete({ input: "start", location: map });
var ac_end = new BMapGL.Autocomplete({ input: "end", location: map });
ac_start.addEventListener("onconfirm", function(e) {
    var _value = e.item.value;
    var address =
        _value.province + _value.city + _value.district + _value.street + _value.business;
    document.getElementById("start").value = address;
});
ac_end.addEventListener("onconfirm", function(e) {
    var _value = e.item.value;
    var address =
        _value.province + _value.city + _value.district + _value.street + _value.business;
    document.getElementById("end").value = address;
});

var localSearch = new BMapGL.LocalSearch(map, { renderOptions: { map: map } });
function searchKeyword() {
    let keyword = document.getElementById("keyword").value.trim();
    if (keyword) {
        clearMap();
        localSearch.search(keyword);
        document.getElementById("result").innerHTML = `ğŸ” å…³é”®å­—â€œ${keyword}â€æ£€ç´¢ä¸­...`;
    } else {
        alert("è¯·è¾“å…¥å…³é”®å­—");
    }
}
</script>
</body>
</html>
